<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Raspberry Pi Kamera √©s Visszasz√°ml√°l√≥</title>
    <style>
        body {
            text-align: center;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 400px;
        }
        
        .camera-section, .photo-section {
            width: 100%;
        }
        
        video, canvas {
            width: 100%;
            height: 300px;
            background-color: #333;
        }
        
        canvas {
            border: 1px solid black;
            background-color: #f0f0f0;
        }
        
        h3 {
            margin-bottom: 10px;
        }
        
        #countdown {
            font-size: 24px;
            margin: 10px;
            height: 30px;
        }
        
        #takePhotoBtn, #sendPhotoBtn {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        #sendPhotoBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        
        #sendPhotoBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #sendPhotoBtn.sent {
            background-color: #2196F3;
        }
        
        .email-display {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #2196F3;
        }
        
        .overlay-section, .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        #overlayContainer {
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        #overlayContainer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border: 1px solid #333;
        }


        .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 5px;
        }

        #saveFinalBtn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #saveFinalBtn:hover {
            background-color: #0b7dda;
        }

        #canvas {
            display: none; /* Elrejtj√ºk az eredeti canvast */
        }
        
        #finalCanvas {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f5f5f5 75%), 
                        linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #333;
            border-radius: 10px;
        }
        
        /* Raspberry Pi kamera st√°tusz */
        .camera-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .camera-status.ready {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .camera-status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        /* Raspberry Pi kamera preview helye */
        #raspberryPreview {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            color: white;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        
        #raspberryPreview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
        }

        /* Kamera kapcsol√≥ gomb */
        #toggleCameraBtn {
            margin: 10px 0;
            padding: 8px 15px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #toggleCameraBtn:hover {
            background-color: #e68a00;
        }

        /* Preview √°llapotok */
        #raspberryPreview.preview-active {
            border: 3px solid #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        
        #raspberryPreview.preview-error {
            border: 3px solid #f44336;
        }
        
        .preview-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- EMAIL C√çM MEGJELEN√çT√âSE -->
    <div class="email-display">
        Email c√≠m: <strong>{{ email }}</strong>
    </div>
    
    <h1>Raspberry Pi Kamera Fot√≥zkod√°s</h1>
    
    <!-- Raspberry Pi kamera st√°tusz -->
    <div id="cameraStatus" class="camera-status">
        {% if camera_available %}
            <div class="camera-status ready">‚úÖ Raspberry Pi Camera V2 el√©rhet≈ë</div>
        {% else %}
            <div class="camera-status error">‚ùå Raspberry Pi Camera V2 nem el√©rhet≈ë</div>
        {% endif %}
    </div>
    
    <div class="media-container">
        <!-- Raspberry Pi Kamera Preview -->
        <div class="camera-section">
            <h3>Raspberry Pi Camera V2</h3>
            <div id="raspberryPreview">
                <div>Kattints a "Kamera bekapcsol√°sa" gombra</div>
            </div>
            <button id="toggleCameraBtn" onclick="toggleRaspberryCamera()">Kamera bekapcsol√°sa</button>
        </div>
        
        <!-- Visszasz√°ml√°l√°s √©s gomb -->
        <div id="countdown"></div>
        <button id="takePhotoBtn" onclick="startCountdown()" disabled>K√©p k√©sz√≠t√©se</button>
        
        <!-- K√©sz√ºlt k√©p -->
        <div class="photo-section">
            <h3>K√©sz√ºlt k√©p (Raspberry Pi)</h3>
            <canvas id="canvas"></canvas>
        </div>
        

        <!-- Overlay k√©p megjelen√≠t√©se -->
        <div class="overlay-section">
            <h3>Kiv√°lasztott h√°tt√©rk√©p</h3>
            <div id="overlayContainer">
                <img id="overlayImage" src="" alt="H√°tt√©rk√©p" style="display: none;">
                <div id="overlayPlaceholder" style="padding: 20px; color: #666;">
                    H√°tt√©rk√©p bet√∂lt√©se...
                </div>
            </div>
            <button id="changeOverlayBtn" onclick="loadRandomOverlay()" style="margin-top: 10px;">
                M√°sik h√°tt√©rk√©p
            </button>
        </div>

        <!-- V√©geredm√©ny -->
        <div class="final-section" style="display: none; margin-top: 20px;">
            <h3>V√©geredm√©ny (Raspberry Pi selfie + h√°tt√©r)</h3>
            <canvas id="finalCanvas"></canvas>
            <button id="saveFinalBtn" onclick="saveFinalImage()" style="margin-top: 10px; display: none;">
                üíæ V√©geredm√©ny ment√©se
            </button>
        </div>

        <!-- K√©p k√ºld√©se gomb -->
        <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>üì§ K√©p k√ºld√©se (Raspberry Pi)</button>
    </div>

    <script>
        // V√ÅLTOZ√ìK
        let currentPhotoData = null;
        let raspberryCameraActive = false;
        let previewInterval = null;
        
        // RASPBERRY PI KAMERA FUNKCI√ìK - EGYETLEN toggleRaspberryCamera()
        function toggleRaspberryCamera() {
            const toggleBtn = document.getElementById('toggleCameraBtn');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const previewDiv = document.getElementById('raspberryPreview');
            
            if (!raspberryCameraActive) {
                // Raspberry kamera bekapcsol√°sa √âL≈ê PREVIEW-VAL
                toggleBtn.textContent = "‚èπÔ∏è Kamera kikapcsol√°sa";
                toggleBtn.style.backgroundColor = "#f44336";
                toggleBtn.disabled = true; // Letiltjuk am√≠g inicializ√°l
                
                // "Kamera ind√≠t√°sa" √ºzenet
                previewDiv.innerHTML = `
                    <div style="text-align: center; color: #ff9800; padding: 40px;">
                        <div style="font-size: 48px;">‚è≥</div>
                        <div style="font-weight: bold; margin: 15px 0;">Raspberry Pi Camera V2 ind√≠t√°sa...</div>
                        <div style="font-size: 14px; color: #aaa;">
                            K√©rlek v√°rj, a kamera inicializ√°l√≥dik
                        </div>
                    </div>
                `;
                previewDiv.className = "";
                
                // API h√≠v√°s a preview ind√≠t√°s√°hoz
                fetch('/raspberry-start-preview/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    toggleBtn.disabled = false;
                    
                    if (data.success) {
                        // Preview aktiv√°lva
                        raspberryCameraActive = true;
                        
                        // √âl≈ë preview szimul√°l√°sa (k√©pek friss√≠t√©se)
                        startLivePreview();
                        
                        // K√©pk√©sz√≠t√©s gomb enged√©lyez√©se
                        takePhotoBtn.disabled = false;
                        
                        console.log("‚úÖ Raspberry Pi √©l≈ë preview aktiv√°lva");
                        
                    } else {
                        // Hiba
                        previewDiv.innerHTML = `
                            <div style="text-align: center; color: #f44336; padding: 40px;">
                                <div style="font-size: 48px;">‚ùå</div>
                                <div style="font-weight: bold; margin: 15px 0;">Kamera hiba</div>
                                <div style="font-size: 14px; color: #aaa;">
                                    ${data.message || 'Nem siker√ºlt elind√≠tani a kamer√°t'}
                                </div>
                                <button onclick="toggleRaspberryCamera()" style="margin-top: 15px; padding: 8px 15px;">
                                    √öjra pr√≥b√°lom
                                </button>
                            </div>
                        `;
                        previewDiv.className = "preview-error";
                        toggleBtn.textContent = "üì∑ Kamera bekapcsol√°sa";
                        toggleBtn.style.backgroundColor = "#ff9800";
                    }
                })
                .catch(error => {
                    toggleBtn.disabled = false;
                    previewDiv.innerHTML = `
                        <div style="text-align: center; color: #f44336; padding: 40px;">
                            <div style="font-size: 48px;">üåê</div>
                            <div style="font-weight: bold; margin: 15px 0;">H√°l√≥zati hiba</div>
                            <div style="font-size: 12px; color: #aaa;">
                                Nem siker√ºlt kapcsol√≥dni a szerverhez
                            </div>
                        </div>
                    `;
                    toggleBtn.textContent = "üì∑ Kamera bekapcsol√°sa";
                    toggleBtn.style.backgroundColor = "#ff9800";
                });
                
            } else {
                // Raspberry kamera kikapcsol√°sa
                stopLivePreview();
                
                // API h√≠v√°s a preview le√°ll√≠t√°s√°hoz
                fetch('/raspberry-stop-preview/', {
                    method: 'POST'
                });
                
                toggleBtn.textContent = "üì∑ Kamera bekapcsol√°sa";
                toggleBtn.style.backgroundColor = "#ff9800";
                previewDiv.innerHTML = `<div style="padding: 40px; text-align: center; color: #666;">
                    Kattints a "Kamera bekapcsol√°sa" gombra
                </div>`;
                previewDiv.className = "";
                takePhotoBtn.disabled = true;
                raspberryCameraActive = false;
                
                console.log("‚úÖ Raspberry Pi preview le√°ll√≠tva");
            }
        }
        
        function startLivePreview() {
            const previewDiv = document.getElementById('raspberryPreview');
            
            // Preview akt√≠v st√≠lus
            previewDiv.className = "preview-active";
            
            // Friss√≠t≈ë funkci√≥ - 2 m√°sodpercenk√©nt √∫j k√©pet k√©r
            previewInterval = setInterval(() => {
                updatePreviewImage();
            }, 2000); // 2 m√°sodpercenk√©nt friss√≠t
            
            // Azonnali els≈ë friss√≠t√©s
            updatePreviewImage();
        }
        
        function stopLivePreview() {
            if (previewInterval) {
                clearInterval(previewInterval);
                previewInterval = null;
            }
        }
        
        function updatePreviewImage() {
            const previewDiv = document.getElementById('raspberryPreview');
            
            // API h√≠v√°s egy gyors preview k√©p√©rt
            fetch('/raspberry-get-preview/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Friss√≠tj√ºk a preview-t az √∫j k√©ppel
                    previewDiv.innerHTML = `
                        <img src="${data.photo_data}" alt="√âl≈ë Preview" 
                             style="max-width: 100%; max-height: 100%;">
                        <div class="preview-indicator">‚óè √âL≈ê</div>
                        <div style="position: absolute; bottom: 10px; left: 10px; 
                                   background: rgba(0,0,0,0.7); color: white; 
                                   padding: 5px; border-radius: 3px; font-size: 11px;">
                            üçì Raspberry Pi V2
                        </div>
                    `;
                } else {
                    // Hiba eset√©n √ºzenet
                    previewDiv.innerHTML = `
                        <div style="text-align: center; color: #ff9800; padding: 30px;">
                            <div style="font-size: 36px;">üì°</div>
                            <div>Preview friss√≠t√©s...</div>
                        </div>
                        <div class="preview-indicator">‚óè √âL≈ê</div>
                    `;
                }
            })
            .catch(error => {
                // Csak logoljuk a hib√°t, ne t√∂r√∂lj√ºk a preview-t
                console.log("Preview friss√≠t√©s hiba:", error);
            });
        }
        
        function startCountdown() {
            if (!raspberryCameraActive) {
                alert("El≈ësz√∂r kapcsold be a Raspberry Pi kamer√°t!");
                return;
            }
            
            let count = 3; // Csak 3 m√°sodperc
            const countdownElement = document.getElementById('countdown');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            const previewDiv = document.getElementById('raspberryPreview');
            
            // Visszasz√°ml√°l√°s ind√≠t√°sa
            takePhotoBtn.disabled = true;
            sendPhotoBtn.disabled = true;
            countdownElement.textContent = count;
            countdownElement.style.fontSize = "48px";
            countdownElement.style.color = "#ff9800";
            
            // Preview friss√≠t√©se visszasz√°ml√°l√°ssal
            previewDiv.innerHTML = `
                <div style="text-align: center; background: rgba(0,0,0,0.8); 
                           color: white; height: 100%; display: flex; 
                           flex-direction: column; justify-content: center;">
                    <div style="font-size: 100px; font-weight: bold;">${count}</div>
                    <div style="margin-top: 20px; font-size: 20px;">K√©sz√ºlj a k√©pre!</div>
                </div>
            `;
            
            const timer = setInterval(function() {
                count--;
                countdownElement.textContent = count;
                
                // Preview friss√≠t√©se
                if (count > 0) {
                    previewDiv.innerHTML = `
                        <div style="text-align: center; background: rgba(0,0,0,0.8); 
                                   color: white; height: 100%; display: flex; 
                                   flex-direction: column; justify-content: center;">
                            <div style="font-size: 100px; font-weight: bold;">${count}</div>
                            <div style="margin-top: 20px; font-size: 20px;">K√©sz√ºlj a k√©pre!</div>
                        </div>
                    `;
                }
                
                if (count <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = "üì∏";
                    countdownElement.style.fontSize = "24px";
                    
                    // Raspberry Pi kamer√°val k√©p k√©sz√≠t√©se
                    takeRaspberryPicture();
                    takePhotoBtn.disabled = false;
                }
            }, 1000);
        }
        
        function takeRaspberryPicture() {
            console.log("=== RASPBERRY PI K√âPK√âSZ√çT√âS ===");
            
            const previewDiv = document.getElementById('raspberryPreview');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            // "K√©sz√ºl..." √ºzenet
            previewDiv.innerHTML = `
                <div style="text-align: center; background: rgba(0,0,0,0.8); 
                           color: white; height: 100%; display: flex; 
                           flex-direction: column; justify-content: center;">
                    <div style="font-size: 60px;">‚è≥</div>
                    <div style="margin-top: 20px; font-size: 20px;">K√©p k√©sz√≠t√©se...</div>
                </div>
            `;
            
            // Raspberry Pi kamera API h√≠v√°sa
            fetch('/raspberry-take-photo/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                console.log("Raspberry kamera v√°lasz:", data);
                
                if (data.success) {
                    // K√©p megjelen√≠t√©se
                    previewDiv.innerHTML = `
                        <img src="${data.photo_data}" alt="Raspberry Pi K√©p" 
                             style="max-width: 100%; max-height: 100%;">
                        <div style="position: absolute; bottom: 10px; right: 10px; 
                                   background: rgba(0,0,0,0.7); color: white; 
                                   padding: 5px; border-radius: 3px; font-size: 12px;">
                            üì∏ K√©sz!
                        </div>
                    `;
                    
                    // T√©nyleges k√©pfeldolgoz√°s
                    processRaspberryPhoto(data.photo_data);
                    
                    // K√©pk√ºld√©s gomb enged√©lyez√©se
                    sendPhotoBtn.disabled = false;
                    sendPhotoBtn.textContent = "üì§ K√©p k√ºld√©se";
                    
                    console.log("‚úÖ Raspberry Pi k√©p sikeresen k√©sz√ºlt");
                    
                } else {
                    // Hiba
                    previewDiv.innerHTML = `
                        <div style="text-align: center; color: #ff6b6b; padding: 40px;">
                            <div style="font-size: 48px;">‚ùå</div>
                            <div style="margin-top: 15px;">Hiba: ${data.message}</div>
                            <button onclick="takeRaspberryPicture()" 
                                    style="margin-top: 15px; padding: 8px 15px;">
                                √öjra pr√≥b√°lom
                            </button>
                        </div>
                    `;
                    
                    alert("‚ùå Hiba: " + data.message);
                    document.getElementById('takePhotoBtn').disabled = false;
                }
            })
            .catch(error => {
                previewDiv.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 40px;">
                        <div style="font-size: 48px;">üåê</div>
                        <div style="margin-top: 15px;">H√°l√≥zati hiba</div>
                    </div>
                `;
                alert("‚ùå H√°l√≥zati hiba");
                document.getElementById('takePhotoBtn').disabled = false;
            });
        }
        
        function processRaspberryPhoto(photoData) {
            // K√©pfeldolgoz√°s (canvas-re rajzol√°s)
            const canvas = document.getElementById('canvas');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // Overlay kombin√°l√°sa
                setTimeout(() => {
                    combineImages();
                }, 500);
            };
            img.src = photoData;
        }
        
        function sendPhoto() {
            const gomb = document.getElementById('sendPhotoBtn');
            const email = "{{ email }}";

            if (!currentPhotoData) {
                alert("Nincs k√©p!");
                return;
            }

            // Gomb letilt
            gomb.disabled = true;
            gomb.textContent = "K√ºld√©s...";

            // K√ºld√©s a szervernek
            fetch('/kuldes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData,
                    camera_type: 'raspberry_pi_v2',
                    timestamp: new Date().toISOString()
                })
            })
            .then(v => v.json())
            .then(eredmeny => {
                if (eredmeny.siker) {
                    gomb.textContent = "‚úÖ Elk√ºldve (Raspberry Pi)";
                    gomb.className = "sent";
                    alert("‚úÖ Raspberry Pi k√©p elk√ºldve!");
                    
                    // 5 m√°sodperc ut√°n vissza√°ll√≠t√°s
                    setTimeout(() => {
                        gomb.textContent = "üì§ K√©p k√ºld√©se (Raspberry Pi)";
                        gomb.disabled = false;
                        gomb.className = "";
                    }, 5000);
                    
                } else {
                    gomb.textContent = "üì§ K√©p k√ºld√©se (Raspberry Pi)";
                    gomb.disabled = false;
                    alert("‚ùå Hiba: " + eredmeny.uzenet);
                }
            })
            .catch(hiba => {
                gomb.textContent = "üì§ K√©p k√ºld√©se (Raspberry Pi)";
                gomb.disabled = false;
                alert("‚ùå H√°l√≥zati hiba");
            });
        }
        
        // Overlay k√©p bet√∂lt√©se oldal bet√∂lt√©sekor
        document.addEventListener('DOMContentLoaded', function() {
            loadOverlay();
        });

        function loadOverlay() {
            const overlayContainer = document.getElementById('overlayContainer');
            const overlayImage = document.getElementById('overlayImage');
            const overlayPlaceholder = document.getElementById('overlayPlaceholder');
            
            // 1. Django template-b≈ël sz√°rmaz√≥ adat
            const djangoOverlayUrl = "{{ overlay_url|safe }}";
            
            if (djangoOverlayUrl && djangoOverlayUrl !== 'None') {
                // Ha van Django adat, haszn√°ljuk
                overlayImage.src = djangoOverlayUrl;
                overlayImage.style.display = 'block';
                if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                console.log("Overlay bet√∂ltve Django template-b≈ël:", djangoOverlayUrl);
                return;
            }
            
            // 2. Ha nincs Django adat, fetchelj√ºk
            if (overlayPlaceholder) {
                overlayPlaceholder.innerHTML = "H√°tt√©rk√©p bet√∂lt√©se...";
            }
            
            fetch('/get-latest-overlay/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.overlay && data.overlay.url) {
                        overlayImage.src = data.overlay.url;
                        overlayImage.style.display = 'block';
                        if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                        
                        // Inform√°ci√≥ megjelen√≠t√©se
                        const infoDiv = document.createElement('div');
                        infoDiv.innerHTML = `
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #555;">
                                <strong>${data.overlay.description || 'Nincs le√≠r√°s'}</strong><br>
                                <small>Felt√∂ltve: ${data.overlay.upload_date}</small>
                            </div>
                        `;
                        
                        // R√©gi info t√∂rl√©se
                        const oldInfo = overlayContainer.querySelector('.overlay-info');
                        if (oldInfo) oldInfo.remove();
                        
                        infoDiv.className = 'overlay-info';
                        overlayContainer.appendChild(infoDiv);
                        
                        console.log("Overlay bet√∂ltve API-b√≥l:", data.overlay.url);
                    } else {
                        if (overlayPlaceholder) {
                            overlayPlaceholder.innerHTML = `
                                <div style="color: #f44336; padding: 20px; text-align: center;">
                                    ‚ùå ${data.message || 'Nincs akt√≠v h√°tt√©rk√©p'}<br>
                                    <small>Az admin oldalon lehet h√°tt√©rk√©peket felt√∂lteni.</small>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error("Hiba a h√°tt√©rk√©p bet√∂lt√©s√©n√©l:", error);
                    if (overlayPlaceholder) {
                        overlayPlaceholder.innerHTML = `
                            <div style="color: #f44336; padding: 20px; text-align: center;">
                                ‚ùå H√°l√≥zati hiba<br>
                                <small>Nem siker√ºlt bet√∂lteni a h√°tt√©rk√©pet.</small>
                            </div>
                        `;
                    }
                });
        }

        function combineImages() {
            console.log("=== RASPBERRY COMBINE IMAGES START ===");
            
            const canvas = document.getElementById('canvas');
            const overlayImg = document.getElementById('overlayImage');
            const finalCanvas = document.getElementById('finalCanvas');
            const finalSection = document.querySelector('.final-section');
            
            if (!canvas) {
                console.log("‚ùå Canvas nem tal√°lhat√≥");
                return;
            }
            
            console.log("Canvas m√©rete:", canvas.width, "x", canvas.height);
            console.log("Overlay k√©p:", overlayImg ? "tal√°lva" : "nem tal√°lva");
            
            if (overlayImg) {
                console.log("Overlay src:", overlayImg.src);
                console.log("Overlay complete:", overlayImg.complete);
                console.log("Overlay natural size:", overlayImg.naturalWidth, "x", overlayImg.naturalHeight);
            }
            
            // V√©geredm√©ny canvas m√©rete - EGY√âNI M√âRET
            finalCanvas.width = 640;  // Fix sz√©less√©g
            finalCanvas.height = 480; // Fix magass√°g
            const ctx = finalCanvas.getContext('2d');
            
            // 1. El≈ësz√∂r t√∂r√∂lj√ºk a canvas-t
            ctx.clearRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // 2. H√°tt√©rk√©p (overlay) - HA VAN
            if (overlayImg && overlayImg.src && overlayImg.complete && overlayImg.naturalWidth > 0) {
                console.log("üì∑ H√°tt√©rk√©p rajzol√°sa...");
                
                // H√°tt√©rk√©p m√©retez√©se hogy kit√∂ltse a canvas-t
                ctx.drawImage(
                    overlayImg, 
                    0, 0,                     // forr√°s poz√≠ci√≥
                    overlayImg.naturalWidth,  // forr√°s sz√©less√©g
                    overlayImg.naturalHeight, // forr√°s magass√°g
                    0, 0,                     // c√©l poz√≠ci√≥
                    finalCanvas.width,        // c√©l sz√©less√©g
                    finalCanvas.height        // c√©l magass√°g
                );
                
                console.log("‚úÖ H√°tt√©rk√©p rajzolva");
            } else {
                console.log("‚ö†Ô∏è Nincs h√°tt√©rk√©p vagy nem t√∂lt≈ëd√∂tt be");
                // Raspberry Pi sz√≠n≈± h√°tt√©r
                ctx.fillStyle = '#C51A4A'; // Raspberry Pi v√∂r√∂s
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // Raspberry Pi log√≥ jelz√©s
                ctx.fillStyle = '#ffffff';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Raspberry Pi Camera V2', finalCanvas.width / 2, finalCanvas.height / 2);
            }
            
            // 3. Raspberry Pi selfie r√°rajzol√°sa (k√∂z√©pre igaz√≠tva)
            console.log("üì∏ Raspberry Pi selfie rajzol√°sa...");
            
            // Selfie m√©retez√©se a canvas-re
            const selfieWidth = finalCanvas.width * 0.8;  // 80%-a a canvas m√©ret√©nek
            const selfieHeight = finalCanvas.height * 0.8;
            const selfieX = (finalCanvas.width - selfieWidth) / 2;  // K√∂z√©pre igaz√≠t√°s
            const selfieY = (finalCanvas.height - selfieHeight) / 2;
            
            ctx.drawImage(
                canvas,
                0, 0,                    // forr√°s poz√≠ci√≥
                canvas.width,            // forr√°s sz√©less√©g
                canvas.height,           // forr√°s magass√°g
                selfieX, selfieY,        // c√©l poz√≠ci√≥
                selfieWidth,             // c√©l sz√©less√©g
                selfieHeight             // c√©l magass√°g
            );
            
            // 4. Raspberry Pi st√≠lus√∫ keret rajzol√°sa
            ctx.strokeStyle = '#C51A4A'; // Raspberry Pi v√∂r√∂s
            ctx.lineWidth = 5;
            ctx.strokeRect(selfieX, selfieY, selfieWidth, selfieHeight);
            
            // 5. "Raspberry Pi Camera V2" felirat
            ctx.fillStyle = '#C51A4A';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Raspberry Pi Camera V2', finalCanvas.width / 2, 30);
            
            console.log("‚úÖ Raspberry Pi selfie rajzolva");
            console.log("Selfie poz√≠ci√≥:", selfieX, selfieY);
            console.log("Selfie m√©rete:", selfieWidth, "x", selfieHeight);
            
            // V√©geredm√©ny megjelen√≠t√©se
            finalSection.style.display = 'block';
            
            // Base64 k√©p a k√ºld√©shez
            currentPhotoData = finalCanvas.toDataURL('image/jpeg', 0.9);
            
            console.log("‚úÖ Raspberry Pi v√©geredm√©ny k√©sz!");
            console.log("=== RASPBERRY COMBINE IMAGES END ===\n");
        }

        // V√©geredm√©ny ment√©se
        function saveFinalImage() {
            if (!currentPhotoData) {
                alert("Nincs k√©p!");
                return;
            }
            
            const finalCanvas = document.getElementById('finalCanvas');
            const imageData = finalCanvas.toDataURL('image/jpeg', 0.9);
            
            // Ment√©s link l√©trehoz√°sa
            const link = document.createElement('a');
            link.download = 'raspberry_pi_selfie.jpg';
            link.href = imageData;
            link.click();
            
            alert("‚úÖ Raspberry Pi k√©p let√∂ltve!");
        }

        // Overlay k√©p ellen≈ërz√©se oldal bet√∂lt√©sekor
        window.addEventListener('load', function() {
            const overlayImg = document.getElementById('overlayImage');
            
            if (overlayImg) {
                console.log("üîç Overlay k√©p ellen≈ërz√©se...");
                
                if (overlayImg.src) {
                    console.log("üìÅ Overlay f√°jl:", overlayImg.src.substring(0, 50) + "...");
                    
                    // K√©p bet√∂lt√©s√©nek ellen≈ërz√©se
                    if (overlayImg.complete && overlayImg.naturalWidth > 0) {
                        console.log("‚úÖ Overlay m√°r bet√∂lt≈ëd√∂tt");
                        console.log("üìè Overlay m√©rete:", overlayImg.naturalWidth, "x", overlayImg.naturalHeight);
                    } else {
                        console.log("‚è≥ Overlay m√©g bet√∂lt≈ëdik...");
                        
                        // Esem√©nyfigyel≈ëk
                        overlayImg.onload = function() {
                            console.log("‚úÖ Overlay bet√∂lt≈ëd√∂tt!");
                            console.log("üìè M√©rete:", this.naturalWidth, "x", this.naturalHeight);
                        };
                        
                        overlayImg.onerror = function() {
                            console.log("‚ùå Hiba az overlay bet√∂lt√©s√©n√©l!");
                        };
                    }
                } else {
                    console.log("‚ö†Ô∏è Overlay-nak nincs src attrib√∫tuma");
                }
            } else {
                console.log("‚ö†Ô∏è Overlay k√©p elem nem tal√°lhat√≥");
            }
        });

        // Gombok kezdeti √°llapota
        document.getElementById('takePhotoBtn').disabled = true;
        document.getElementById('sendPhotoBtn').disabled = true;
    </script>
</body>
</html>