<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Raspberry Pi Kamera √©s Visszasz√°ml√°l√≥</title>
    <style>
        body {
            text-align: center;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 400px;
        }
        
        .camera-section, .photo-section {
            width: 100%;
        }
        
        video, canvas {
            width: 100%;
            height: 300px;
            background-color: #333;
        }
        
        canvas {
            border: 1px solid black;
            background-color: #f0f0f0;
        }
        
        h3 {
            margin-bottom: 10px;
        }
        
        #countdown {
            font-size: 24px;
            margin: 10px;
            height: 30px;
        }
        
        #takePhotoBtn, #sendPhotoBtn {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        #sendPhotoBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        
        #sendPhotoBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #sendPhotoBtn.sent {
            background-color: #2196F3;
        }
        
        .email-display {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #2196F3;
        }
        
        .overlay-section, .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        #overlayContainer {
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        #overlayContainer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border: 1px solid #333;
        }


        .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 5px;
        }

        #saveFinalBtn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #saveFinalBtn:hover {
            background-color: #0b7dda;
        }

        #canvas {
            display: none; /* Elrejtj√ºk az eredeti canvast */
        }
        
        #finalCanvas {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f5f5f5 75%), 
                        linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #333;
            border-radius: 10px;
        }
        
        /* Raspberry Pi kamera st√°tusz */
        .camera-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .camera-status.ready {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .camera-status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        /* Raspberry Pi kamera preview helye */
        #raspberryPreview {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            color: white;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        
        #raspberryPreview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
        }

        /* Kamera kapcsol√≥ gomb */
        #toggleCameraBtn {
            margin: 10px 0;
            padding: 8px 15px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #toggleCameraBtn:hover {
            background-color: #e68a00;
        }

        /* Preview √°llapotok */
        #raspberryPreview.preview-active {
            border: 3px solid #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        
        #raspberryPreview.preview-error {
            border: 3px solid #f44336;
        }
        
        .preview-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- EMAIL C√çM MEGJELEN√çT√âSE -->
    <div class="email-display">
        Email c√≠m: <strong>{{ email }}</strong>
    </div>
    
    <h1>Raspberry Pi Kamera Fot√≥zkod√°s</h1>
    
    <!-- Raspberry Pi kamera st√°tusz -->
    <div id="cameraStatus" class="camera-status">
        {% if camera_available %}
            <div class="camera-status ready">‚úÖ Raspberry Pi Camera V2 el√©rhet≈ë</div>
        {% else %}
            <div class="camera-status error">‚ùå Raspberry Pi Camera V2 nem el√©rhet≈ë</div>
        {% endif %}
    </div>
    
    <div class="media-container">
        <!-- Raspberry Pi Kamera Preview -->
        <div class="camera-section">
            <h3>Raspberry Pi Camera V2</h3>
            <div id="raspberryPreview">
                <div>Kattints a "Kamera bekapcsol√°sa" gombra</div>
            </div>
            <button id="toggleCameraBtn" onclick="toggleRaspberryCamera()">Kamera bekapcsol√°sa</button>
        </div>
        
        <!-- Visszasz√°ml√°l√°s √©s gomb -->
        <div id="countdown"></div>
        <button id="takePhotoBtn" onclick="startCountdown()" disabled>K√©p k√©sz√≠t√©se</button>
        
        <!-- K√©sz√ºlt k√©p -->
        <div class="photo-section">
            <h3>K√©sz√ºlt k√©p (Raspberry Pi)</h3>
            <canvas id="canvas"></canvas>
        </div>
        

        <!-- Overlay k√©p megjelen√≠t√©se -->
        <div class="overlay-section">
            <h3>Kiv√°lasztott h√°tt√©rk√©p</h3>
            <div id="overlayContainer">
                <img id="overlayImage" src="" alt="H√°tt√©rk√©p" style="display: none;">
                <div id="overlayPlaceholder" style="padding: 20px; color: #666;">
                    H√°tt√©rk√©p bet√∂lt√©se...
                </div>
            </div>
            <button id="changeOverlayBtn" onclick="loadRandomOverlay()" style="margin-top: 10px;">
                M√°sik h√°tt√©rk√©p
            </button>
        </div>

        <!-- V√©geredm√©ny -->
        <div class="final-section" style="display: none; margin-top: 20px;">
            <h3>V√©geredm√©ny (Raspberry Pi selfie + h√°tt√©r)</h3>
            <canvas id="finalCanvas"></canvas>
            <button id="saveFinalBtn" onclick="saveFinalImage()" style="margin-top: 10px; display: none;">
                üíæ V√©geredm√©ny ment√©se
            </button>
        </div>

        <!-- K√©p k√ºld√©se gomb -->
        <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>üì§ K√©p k√ºld√©se (Raspberry Pi)</button>
    </div>




    <div style="position: fixed; top: 10px; right: 10px; background: white; padding: 10px; border: 1px solid #ccc; z-index: 1000;">
    <h4>Debug</h4>
    <button onclick="testPost()">Test POST</button>
    <button onclick="testGet()">Test GET</button>
    <div id="debugResult" style="margin-top: 10px; font-size: 12px;"></div>
    </div>















    <script>
        
        // Debug funkci√≥k
        function testPost() {
            fetch('/raspberry-start-preview/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({test: true})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('debugResult').innerHTML = 
                    `POST: ${JSON.stringify(data)}`;
            })
            .catch(e => {
                document.getElementById('debugResult').innerHTML = 
                    `POST Hiba: ${e}`;
            });
        }

        function testGet() {
            fetch('/raspberry-start-preview/')
            .then(r => r.json())
            .then(data => {
                document.getElementById('debugResult').innerHTML = 
                    `GET: ${JSON.stringify(data)}`;
            })
            .catch(e => {
                document.getElementById('debugResult').innerHTML = 
                    `GET Hiba: ${e}`;
            });
        }








        // --- √ÅLLAPOT ---
        let currentPhotoData = null;
        let cameraReady = false;

        // --- "KAMERA BEKAPCSOL√ÅSA" = CSAK UI ---
        function toggleRaspberryCamera() {
            const toggleBtn = document.getElementById('toggleCameraBtn');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const previewDiv = document.getElementById('raspberryPreview');

            cameraReady = true;

            toggleBtn.textContent = "‚úÖ Kamera k√©sz";
            toggleBtn.disabled = true;
            toggleBtn.style.backgroundColor = "#4caf50";

            previewDiv.innerHTML = `
                <div style="padding:40px;text-align:center;color:#4caf50;">
                    <div style="font-size:48px;">üì∑</div>
                    <div>Kamera k√©szen √°ll</div>
                </div>
            `;

            takePhotoBtn.disabled = false;
        }

        // --- VISSZASZ√ÅML√ÅL√ÅS (UI ONLY) ---
        function startCountdown() {
            if (!cameraReady) {
                alert("El≈ëbb kapcsold be a kamer√°t!");
                return;
            }

            const countdown = document.getElementById('countdown');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            let count = 3;

            takePhotoBtn.disabled = true;
            countdown.style.fontSize = "48px";
            countdown.textContent = count;

            const timer = setInterval(() => {
                count--;
                countdown.textContent = count > 0 ? count : "üì∏";

                if (count <= 0) {
                    clearInterval(timer);
                    countdown.textContent = "";
                    takeRaspberryPicture();
                }
            }, 1000);
        }

        // --- K√âPK√âSZ√çT√âS (AZ EGYETLEN KAMERA-H√çV√ÅS) ---
        function takeRaspberryPicture() {
            const previewDiv = document.getElementById('raspberryPreview');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            const takePhotoBtn = document.getElementById('takePhotoBtn');

            previewDiv.innerHTML = `
                <div style="padding:40px;text-align:center;color:white;background:#000;">
                    <div style="font-size:48px;">‚è≥</div>
                    <div>K√©p k√©sz√≠t√©se...</div>
                </div>
            `;

            takePhotoBtn.disabled = true;
            sendPhotoBtn.disabled = true;

            fetch('/raspberry-take-photo/', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Ismeretlen hiba');
                }

                // ‚úÖ A K√âP M√ÅR BASE64
                currentPhotoData = data.photo_data;

                previewDiv.innerHTML = `
                    <img src="${currentPhotoData}" style="max-width:100%; max-height:100%;">
                    <div style="margin-top:10px;color:#4caf50;">üì∏ K√©sz!</div>
                `;

                processRaspberryPhoto(currentPhotoData);
                sendPhotoBtn.disabled = false;
                takePhotoBtn.disabled = false;
            })
            .catch(err => {
                previewDiv.innerHTML = `
                    <div style="padding:40px;text-align:center;color:#f44336;">
                        ‚ùå ${err.message}
                    </div>
                `;
                takePhotoBtn.disabled = false;
            });
        }


        // --- K√âP CANVAS-RA ---
        function processRaspberryPhoto(photoData) {
            const canvas = document.getElementById('canvas');
            const img = new Image();

            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                setTimeout(combineImages, 300);
            };

            img.src = photoData;
        }

        // --- K√úLD√âS EMAILBEN ---
        function sendPhoto() {
            const btn = document.getElementById('sendPhotoBtn');
            const email = "{{ email }}";

            btn.disabled = true;
            btn.textContent = "K√ºld√©s...";

            fetch('/kuldes/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData
                })
            })
            .then(r => r.json())
            .then(res => {
                if (res.siker) {
                    btn.textContent = "‚úÖ Elk√ºldve";
                } else {
                    throw new Error(res.uzenet);
                }
            })
            .catch(err => {
                alert("Hiba: " + err.message);
                btn.disabled = false;
                btn.textContent = "üì§ K√©p k√ºld√©se";
            });
        }

        // --- INIT ---
        document.getElementById('takePhotoBtn').disabled = true;
        document.getElementById('sendPhotoBtn').disabled = true;

        
        





        
    </script>
</body>
</html>