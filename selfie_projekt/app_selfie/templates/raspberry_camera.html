<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Raspberry Pi Selfie Kamera</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .email-display {
            margin: 20px auto;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 10px;
            border: 2px solid #2196F3;
            max-width: 500px;
            font-size: 18px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .camera-status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .camera-status.ready {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .camera-status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        #photoPreview {
            width: 100%;
            max-width: 480px;
            height: 360px;
            margin: 20px auto;
            border: 3px solid #ddd;
            border-radius: 10px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 18px;
        }
        
        #photoPreview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        
        .buttons {
            margin: 30px 0;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        #takePhotoBtn {
            background-color: #ff9800;
            color: white;
        }
        
        #takePhotoBtn:hover:not(:disabled) {
            background-color: #e68a00;
        }
        
        #sendPhotoBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #sendPhotoBtn:hover:not(:disabled) {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #countdown {
            font-size: 32px;
            margin: 20px;
            height: 40px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .status-message {
            margin: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- EMAIL C√çM MEGJELEN√çT√âSE -->
        <div class="email-display">
            üìß Email c√≠m: <strong>{{ email }}</strong>
        </div>
        
        <h1>üì∏ Raspberry Pi Selfie Kamera</h1>
        
        <!-- Kamera st√°tusz -->
        <div id="cameraStatus" class="camera-status">
            {% if camera_available %}
                ‚úÖ Raspberry Pi kamera el√©rhet≈ë
            {% else %}
                ‚ùå Raspberry Pi kamera nem el√©rhet≈ë
            {% endif %}
        </div>
        
        <!-- Visszasz√°ml√°l√°s -->
        <div id="countdown"></div>
        
        <!-- K√©p el≈ën√©zet -->
        <div id="photoPreview">
            <div>Kattints a "K√©p k√©sz√≠t√©se" gombra</div>
        </div>
        
        <!-- Gombok -->
        <div class="buttons">
            <button id="takePhotoBtn" onclick="startCountdown()">K√©p k√©sz√≠t√©se</button>
            <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>üì§ K√©p k√ºld√©se</button>
        </div>
        
        <!-- Vissza gomb -->
        <div style="margin-top: 30px;">
            <a href="/">‚¨ÖÔ∏è Vissza a kezd≈ëoldalra</a>
        </div>
        
        <!-- √Ållapot√ºzenet -->
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        let currentPhotoData = null;
        
        function startCountdown() {
            let count = 5;
            const countdownElement = document.getElementById('countdown');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            // Gombok letilt√°sa
            takePhotoBtn.disabled = true;
            sendPhotoBtn.disabled = true;
            
            // Sz√°ml√°l√≥ ind√≠t√°sa
            countdownElement.textContent = count;
            countdownElement.style.color = '#2196F3';
            
            statusMessage.textContent = `K√©sz√ºlj! K√©p ${count} m√°sodperc m√∫lva...`;
            statusMessage.className = 'status-message';
            
            const timer = setInterval(function() {
                count--;
                countdownElement.textContent = count;
                statusMessage.textContent = `K√©sz√ºlj! K√©p ${count} m√°sodperc m√∫lva...`;
                
                // Sz√≠n v√°ltoztat√°s
                if (count <= 2) {
                    countdownElement.style.color = '#f44336';
                }
                
                if (count <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = "MOSOLYOGJ! üòä";
                    statusMessage.textContent = "K√©p k√©sz√≠t√©se...";
                    
                    // Raspberry kamer√°val k√©p k√©sz√≠t√©se
                    setTimeout(takePicture, 500);
                }
            }, 1000);
        }
        
        function takePicture() {
            const statusMessage = document.getElementById('statusMessage');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            statusMessage.textContent = "Kamera haszn√°lata...";
            
            // Raspberry Pi kamera h√≠v√°sa
            fetch('/raspberry-take-photo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentPhotoData = data.photo_data;
                    
                    // K√©p megjelen√≠t√©se
                    const photoPreview = document.getElementById('photoPreview');
                    photoPreview.innerHTML = `<img src="${data.photo_data}" alt="K√©sz√ºlt k√©p">`;
                    
                    // Gombok enged√©lyez√©se
                    takePhotoBtn.disabled = false;
                    sendPhotoBtn.disabled = false;
                    
                    statusMessage.textContent = "‚úÖ K√©p k√©sz√ºlt!";
                    statusMessage.className = 'status-message success';
                    
                    // Visszasz√°ml√°l√≥ vissza√°ll√≠t√°sa
                    document.getElementById('countdown').textContent = "";
                    
                } else {
                    statusMessage.textContent = "‚ùå Hiba: " + data.message;
                    statusMessage.className = 'status-message error';
                    takePhotoBtn.disabled = false;
                }
            })
            .catch(error => {
                statusMessage.textContent = "‚ùå H√°l√≥zati hiba";
                statusMessage.className = 'status-message error';
                takePhotoBtn.disabled = false;
            });
        }
        
        function sendPhoto() {
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            const statusMessage = document.getElementById('statusMessage');
            const email = "{{ email }}";
            
            if (!currentPhotoData) {
                alert("Nincs k√©p!");
                return;
            }
            
            // Gomb letilt√°sa
            sendPhotoBtn.disabled = true;
            sendPhotoBtn.textContent = "K√ºld√©s...";
            
            statusMessage.textContent = "Email k√ºld√©se...";
            
            // K√ºld√©s a megl√©v≈ë email_kuldes endpoint-nak
            fetch('/kuldes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.siker) {
                    sendPhotoBtn.textContent = "‚úÖ Elk√ºldve";
                    sendPhotoBtn.style.backgroundColor = '#2196F3';
                    statusMessage.textContent = "‚úÖ K√©p sikeresen elk√ºldve!";
                    statusMessage.className = 'status-message success';
                    
                    // 5 m√°sodperc ut√°n vissza√°ll√≠t√°s
                    setTimeout(() => {
                        sendPhotoBtn.textContent = "üì§ K√©p k√ºld√©se";
                        sendPhotoBtn.style.backgroundColor = '';
                        sendPhotoBtn.disabled = true;
                        statusMessage.textContent = "";
                    }, 5000);
                    
                } else {
                    sendPhotoBtn.textContent = "üì§ K√©p k√ºld√©se";
                    sendPhotoBtn.disabled = false;
                    statusMessage.textContent = "‚ùå Hiba: " + data.uzenet;
                    statusMessage.className = 'status-message error';
                }
            })
            .catch(error => {
                sendPhotoBtn.textContent = "üì§ K√©p k√ºld√©se";
                sendPhotoBtn.disabled = false;
                statusMessage.textContent = "‚ùå H√°l√≥zati hiba";
                statusMessage.className = 'status-message error';
            });
        }
    </script>
</body>
</html>