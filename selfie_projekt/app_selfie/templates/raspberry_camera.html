<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Raspberry Pi Kamera</title>
    <style>
        body { text-align: center; font-family: Arial; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        #photoPreview { width: 480px; height: 360px; margin: 20px auto; border: 2px solid #ccc; }
        #photoPreview img { max-width: 100%; max-height: 100%; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px; }
        #countdown { font-size: 24px; margin: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Raspberry Pi Kamera</h1>
        
        <div id="cameraStatus">
            {% if camera_available %}
                ‚úÖ Kamera el√©rhet≈ë
            {% else %}
                ‚ùå Kamera nem el√©rhet≈ë
            {% endif %}
        </div>
        
        <div id="countdown"></div>
        
        <div id="photoPreview">
            <div>Kattints a "K√©p k√©sz√≠t√©se" gombra</div>
        </div>
        
        <div>
            <button id="takePhotoBtn" onclick="startCountdown()">K√©p k√©sz√≠t√©se</button>
            <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>üì§ K√©p k√ºld√©se</button>
        </div>
        
        <div id="statusMessage"></div>
    </div>

    <script>
        let currentPhotoData = null;
        
        function startCountdown() {
            let count = 3;
            document.getElementById('takePhotoBtn').disabled = true;
            
            const timer = setInterval(() => {
                document.getElementById('countdown').textContent = count;
                count--;
                
                if (count < 0) {
                    clearInterval(timer);
                    document.getElementById('countdown').textContent = "";
                    takePicture();
                }
            }, 1000);
        }
        
        function takePicture() {
            fetch('/raspberry-take-photo/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentPhotoData = data.photo_data;
                    document.getElementById('photoPreview').innerHTML = 
                        `<img src="${data.photo_data}" alt="K√©sz√ºlt k√©p">`;
                    document.getElementById('takePhotoBtn').disabled = false;
                    document.getElementById('sendPhotoBtn').disabled = false;
                } else {
                    alert("Hiba: " + data.message);
                    document.getElementById('takePhotoBtn').disabled = false;
                }
            });
        }
        
        function sendPhoto() {
            if (!currentPhotoData) return;
            
            const email = "{{ email }}";
            document.getElementById('sendPhotoBtn').disabled = true;
            
            fetch('/kuldes/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.siker) {
                    document.getElementById('statusMessage').textContent = "‚úÖ K√©p elk√ºldve!";
                } else {
                    document.getElementById('statusMessage').textContent = "‚ùå Hiba: " + data.uzenet;
                    document.getElementById('sendPhotoBtn').disabled = false;
                }
            });
        }
    </script>
</body>
</html>