<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Kamera √©s Visszasz√°ml√°l√≥</title>
    <style>
        body {
            text-align: center;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 400px;
        }
        
        .camera-section, .photo-section {
            width: 100%;
        }
        
        video, canvas {
            width: 100%;
            height: 300px;
            background-color: #333;
        }
        
        canvas {
            border: 1px solid black;
            background-color: #f0f0f0;
        }
        
        h3 {
            margin-bottom: 10px;
        }
        
        #countdown {
            font-size: 24px;
            margin: 10px;
            height: 30px;
        }
        
        #takePhotoBtn, #sendPhotoBtn {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        #sendPhotoBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        
        #sendPhotoBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #sendPhotoBtn.sent {
            background-color: #2196F3;
        }
        
        .email-display {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #2196F3;
        }
        
        .overlay-section, .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        #overlayContainer {
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        #overlayContainer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border: 1px solid #333;
        }


        .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 5px;
        }

        #saveFinalBtn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #saveFinalBtn:hover {
            background-color: #0b7dda;
        }



        #canvas {
            display: none; /* Elrejtj√ºk az eredeti canvast */
        }
        
        #finalCanvas {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f5f5f5 75%), 
                        linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #333;
            border-radius: 10px;
        }

















    </style>
</head>
<body>
    <!-- EMAIL C√çM MEGJELEN√çT√âSE -->
    <div class="email-display">
        Email c√≠m: <strong>{{ email }}</strong>
    </div>
    
    <h1>Fot√≥zkod√°s</h1>
    
    <button onclick="bekapcsolKamera()">Kamera ind√≠t√°sa</button>
    
    <div class="media-container">
        <!-- Kamera -->
        <div class="camera-section">
            <h3>Kamera</h3>
            <video id="video"></video>
        </div>
        
        <!-- Visszasz√°ml√°l√°s √©s gomb -->
        <div id="countdown"></div>
        <button id="takePhotoBtn" onclick="startCountdown()">K√©p k√©sz√≠t√©se</button>
        
        <!-- K√©sz√ºlt k√©p -->
        <div class="photo-section">
            <h3>K√©sz√ºlt k√©p</h3>
            <canvas id="canvas"></canvas>
        </div>
        

        <!-- Overlay k√©p megjelen√≠t√©se -->
        <div class="overlay-section">
            <h3>Kiv√°lasztott h√°tt√©rk√©p</h3>
            <div id="overlayContainer">
                <img id="overlayImage" src="" alt="H√°tt√©rk√©p" style="display: none;">
                <div id="overlayPlaceholder" style="padding: 20px; color: #666;">
                    H√°tt√©rk√©p bet√∂lt√©se...
                </div>
            </div>
            <button id="changeOverlayBtn" onclick="loadRandomOverlay()" style="margin-top: 10px;">
                M√°sik h√°tt√©rk√©p
            </button>
        </div>

        <!-- V√©geredm√©ny -->
        <div class="final-section" style="display: none; margin-top: 20px;">
            <h3>V√©geredm√©ny (selfie + h√°tt√©r)</h3>
            <canvas id="finalCanvas"></canvas>
            <button id="saveFinalBtn" onclick="saveFinalImage()" style="margin-top: 10px; display: none;">
                üíæ V√©geredm√©ny ment√©se
            </button>
        </div>






        <!-- K√©p k√ºld√©se gomb -->
        <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>K√©p k√ºld√©se</button>
    </div>

    <script>
        let currentPhotoData = null;
        
        function bekapcsolKamera() {
            const video = document.getElementById('video');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                        takePhotoBtn.disabled = false;
                    })
                    .catch(function(error) {
                        alert("Hiba: " + error.message);
                    });
            } else {
                alert("A b√∂ng√©sz≈ë nem t√°mogatja a kamer√°t");
            }
        }

        function startCountdown() {
            let count = 5;
            const countdownElement = document.getElementById('countdown');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            takePhotoBtn.disabled = true;
            sendPhotoBtn.textContent = "K√©p k√ºld√©se";
            sendPhotoBtn.className = "";
            sendPhotoBtn.disabled = true;
            countdownElement.textContent = count;
            
            const timer = setInterval(function() {
                count--;
                countdownElement.textContent = count;
                
                if (count <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = "Visszasz√°ml√°l√°s v√©ge!";
                    // K√©p k√©sz√≠t√©se
                    takePicture();
                    takePhotoBtn.disabled = false;
                }
            }, 1000);
        }

        function takePicture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            console.log("=== TAKE PICTURE START ===");
            
            // Selfie canvas m√©rete
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            
            // K√©p k√©sz√≠t√©se a vide√≥r√≥l
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            console.log("Selfie canvas m√©rete:", canvas.width, "x", canvas.height);
            console.log("Selfie k√©sz√ºlt!");
            
            // V√°rj egy kicsit, hogy biztosan bet√∂lt≈ëdj√∂n minden
            setTimeout(() => {
                combineImages();
                
                // K√©pk√ºld√©s gomb enged√©lyez√©se
                sendPhotoBtn.disabled = false;
                sendPhotoBtn.textContent = "üì§ K√©p k√ºld√©se";
                
                alert("‚úÖ K√©p k√©sz√ºlt! N√©zd meg az √∂sszeolvasztott verzi√≥t lent!");
            }, 100);
            
            console.log("=== TAKE PICTURE END ===\n");
        }
        
        function sendPhoto() {
            const gomb = document.getElementById('sendPhotoBtn');
            const email = "{{ email }}";
    
            if (!currentPhotoData) {
                alert("Nincs k√©p!");
                return;
            }
    
            // Gomb letilt
            gomb.disabled = true;
            gomb.textContent = "K√ºld√©s...";
    
            // K√ºld√©s a szervernek
            fetch('/kuldes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData
                })
            })
            .then(v => v.json())
            .then(eredmeny => {
                if (eredmeny.siker) {
                    gomb.textContent = "Elk√ºldve";
                    gomb.className = "sent";
                    alert("‚úÖ K√©p elk√ºldve!");
                } else {
                    gomb.textContent = "K√©p k√ºld√©se";
                    gomb.disabled = false;
                    alert("‚ùå Hiba: " + eredmeny.uzenet);
                }
            })
            .catch(hiba => {
                gomb.textContent = "K√©p k√ºld√©se";
                gomb.disabled = false;
                alert("‚ùå H√°l√≥zati hiba");
            });
        }
        
        // Gombok kezdetben letiltva
        document.getElementById('takePhotoBtn').disabled = true;
        document.getElementById('sendPhotoBtn').disabled = true;



        // Overlay k√©p bet√∂lt√©se oldal bet√∂lt√©sekor
        document.addEventListener('DOMContentLoaded', function() {
            loadOverlay();
        });

        function loadOverlay() {
            const overlayContainer = document.getElementById('overlayContainer');
            const overlayImage = document.getElementById('overlayImage');
            const overlayPlaceholder = document.getElementById('overlayPlaceholder');
            
            // 1. Django template-b≈ël sz√°rmaz√≥ adat
            const djangoOverlayUrl = "{{ overlay_url|safe }}";
            
            if (djangoOverlayUrl && djangoOverlayUrl !== 'None') {
                // Ha van Django adat, haszn√°ljuk
                overlayImage.src = djangoOverlayUrl;
                overlayImage.style.display = 'block';
                if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                console.log("Overlay bet√∂ltve Django template-b≈ël:", djangoOverlayUrl);
                return;
            }
            
            // 2. Ha nincs Django adat, fetchelj√ºk
            if (overlayPlaceholder) {
                overlayPlaceholder.innerHTML = "H√°tt√©rk√©p bet√∂lt√©se...";
            }
            
            fetch('/get-latest-overlay/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.overlay && data.overlay.url) {
                        overlayImage.src = data.overlay.url;
                        overlayImage.style.display = 'block';
                        if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                        
                        // Inform√°ci√≥ megjelen√≠t√©se
                        const infoDiv = document.createElement('div');
                        infoDiv.innerHTML = `
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #555;">
                                <strong>${data.overlay.description || 'Nincs le√≠r√°s'}</strong><br>
                                <small>Felt√∂ltve: ${data.overlay.upload_date}</small>
                            </div>
                        `;
                        
                        // R√©gi info t√∂rl√©se
                        const oldInfo = overlayContainer.querySelector('.overlay-info');
                        if (oldInfo) oldInfo.remove();
                        
                        infoDiv.className = 'overlay-info';
                        overlayContainer.appendChild(infoDiv);
                        
                        console.log("Overlay bet√∂ltve API-b√≥l:", data.overlay.url);
                    } else {
                        if (overlayPlaceholder) {
                            overlayPlaceholder.innerHTML = `
                                <div style="color: #f44336; padding: 20px; text-align: center;">
                                    ‚ùå ${data.message || 'Nincs akt√≠v h√°tt√©rk√©p'}<br>
                                    <small>Az admin oldalon lehet h√°tt√©rk√©peket felt√∂lteni.</small>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error("Hiba a h√°tt√©rk√©p bet√∂lt√©s√©n√©l:", error);
                    if (overlayPlaceholder) {
                        overlayPlaceholder.innerHTML = `
                            <div style="color: #f44336; padding: 20px; text-align: center;">
                                ‚ùå H√°l√≥zati hiba<br>
                                <small>Nem siker√ºlt bet√∂lteni a h√°tt√©rk√©pet.</small>
                            </div>
                        `;
                    }
                });
        }

        function combineImages() {
            console.log("=== COMBINE IMAGES START ===");
            
            const canvas = document.getElementById('canvas');
            const overlayImg = document.getElementById('overlayImage');
            const finalCanvas = document.getElementById('finalCanvas');
            const finalSection = document.querySelector('.final-section');
            
            if (!canvas) {
                console.log("‚ùå Canvas nem tal√°lhat√≥");
                return;
            }
            
            console.log("Canvas m√©rete:", canvas.width, "x", canvas.height);
            console.log("Overlay k√©p:", overlayImg ? "tal√°lva" : "nem tal√°lva");
            
            if (overlayImg) {
                console.log("Overlay src:", overlayImg.src);
                console.log("Overlay complete:", overlayImg.complete);
                console.log("Overlay natural size:", overlayImg.naturalWidth, "x", overlayImg.naturalHeight);
            }
            
            // V√©geredm√©ny canvas m√©rete - EGY√âNI M√âRET
            finalCanvas.width = 640;  // Fix sz√©less√©g
            finalCanvas.height = 480; // Fix magass√°g
            const ctx = finalCanvas.getContext('2d');
            
            // 1. El≈ësz√∂r t√∂r√∂lj√ºk a canvas-t
            ctx.clearRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // 2. H√°tt√©rk√©p (overlay) - HA VAN
            if (overlayImg && overlayImg.src && overlayImg.complete && overlayImg.naturalWidth > 0) {
                console.log("üì∑ H√°tt√©rk√©p rajzol√°sa...");
                
                // H√°tt√©rk√©p m√©retez√©se hogy kit√∂ltse a canvas-t
                ctx.drawImage(
                    overlayImg, 
                    0, 0,                     // forr√°s poz√≠ci√≥
                    overlayImg.naturalWidth,  // forr√°s sz√©less√©g
                    overlayImg.naturalHeight, // forr√°s magass√°g
                    0, 0,                     // c√©l poz√≠ci√≥
                    finalCanvas.width,        // c√©l sz√©less√©g
                    finalCanvas.height        // c√©l magass√°g
                );
                
                console.log("‚úÖ H√°tt√©rk√©p rajzolva");
            } else {
                console.log("‚ö†Ô∏è Nincs h√°tt√©rk√©p vagy nem t√∂lt≈ëd√∂tt be");
                // Feh√©r h√°tt√©r
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            }
            
            // 3. Selfie r√°rajzol√°sa (k√∂z√©pre igaz√≠tva)
            console.log("üì∏ Selfie rajzol√°sa...");
            
            // Selfie m√©retez√©se a canvas-re
            const selfieWidth = finalCanvas.width * 0.8;  // 80%-a a canvas m√©ret√©nek
            const selfieHeight = finalCanvas.height * 0.8;
            const selfieX = (finalCanvas.width - selfieWidth) / 2;  // K√∂z√©pre igaz√≠t√°s
            const selfieY = (finalCanvas.height - selfieHeight) / 2;
            
            ctx.drawImage(
                canvas,
                0, 0,                    // forr√°s poz√≠ci√≥
                canvas.width,            // forr√°s sz√©less√©g
                canvas.height,           // forr√°s magass√°g
                selfieX, selfieY,        // c√©l poz√≠ci√≥
                selfieWidth,             // c√©l sz√©less√©g
                selfieHeight             // c√©l magass√°g
            );
            
            // 4. Keret rajzol√°sa a selfie k√∂r√© (opcion√°lis)
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.strokeRect(selfieX, selfieY, selfieWidth, selfieHeight);
            
            console.log("‚úÖ Selfie rajzolva");
            console.log("Selfie poz√≠ci√≥:", selfieX, selfieY);
            console.log("Selfie m√©rete:", selfieWidth, "x", selfieHeight);
            
            // V√©geredm√©ny megjelen√≠t√©se
            finalSection.style.display = 'block';
            
            // Base64 k√©p a k√ºld√©shez
            currentPhotoData = finalCanvas.toDataURL('image/jpeg', 0.9);
            
            console.log("‚úÖ V√©geredm√©ny k√©sz!");
            console.log("=== COMBINE IMAGES END ===\n");
        }

        // Csak selfie (ha nincs overlay)
        function fallbackToSelfieOnly(ctx, canvas, finalSection, saveFinalBtn) {
            ctx.drawImage(canvas, 0, 0);
            finalSection.style.display = 'block';
            saveFinalBtn.style.display = 'none';
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            console.log("‚ö†Ô∏è Csak selfie (nincs h√°tt√©r)");
        }

        // V√©geredm√©ny ment√©se
        function saveFinalImage() {
            if (!currentPhotoData) {
                alert("Nincs k√©p!");
                return;
            }
            
            const finalCanvas = document.getElementById('finalCanvas');
            const imageData = finalCanvas.toDataURL('image/jpeg', 0.9);
            
            // Itt lehetne menteni a szerverre
            console.log("V√©geredm√©ny mentve:", imageData.substring(0, 50) + "...");
            alert("V√©geredm√©ny elk√©sz√ºlt!");
        }




        // Ellen≈ërizz√ºk az overlay k√©pet oldal bet√∂lt√©sekor
        window.addEventListener('load', function() {
            const overlayImg = document.getElementById('overlayImage');
            
            if (overlayImg) {
                console.log("üîç Overlay k√©p ellen≈ërz√©se...");
                
                if (overlayImg.src) {
                    console.log("üìÅ Overlay f√°jl:", overlayImg.src.substring(0, 50) + "...");
                    
                    // K√©p bet√∂lt√©s√©nek ellen≈ërz√©se
                    if (overlayImg.complete && overlayImg.naturalWidth > 0) {
                        console.log("‚úÖ Overlay m√°r bet√∂lt≈ëd√∂tt");
                        console.log("üìè Overlay m√©rete:", overlayImg.naturalWidth, "x", overlayImg.naturalHeight);
                    } else {
                        console.log("‚è≥ Overlay m√©g bet√∂lt≈ëdik...");
                        
                        // Esem√©nyfigyel≈ëk
                        overlayImg.onload = function() {
                            console.log("‚úÖ Overlay bet√∂lt≈ëd√∂tt!");
                            console.log("üìè M√©rete:", this.naturalWidth, "x", this.naturalHeight);
                        };
                        
                        overlayImg.onerror = function() {
                            console.log("‚ùå Hiba az overlay bet√∂lt√©s√©n√©l!");
                        };
                    }
                } else {
                    console.log("‚ö†Ô∏è Overlay-nak nincs src attrib√∫tuma");
                }
            } else {
                console.log("‚ö†Ô∏è Overlay k√©p elem nem tal√°lhat√≥");
            }
        });













    </script>
</body>
</html>