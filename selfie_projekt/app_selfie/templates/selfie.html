<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Kamera és Visszaszámláló</title>
    <style>
        body {
            text-align: center;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 400px;
        }
        
        .camera-section, .photo-section {
            width: 100%;
        }
        
        video, canvas {
            width: 100%;
            height: 300px;
            background-color: #333;
        }
        
        canvas {
            border: 1px solid black;
            background-color: #f0f0f0;
        }
        
        h3 {
            margin-bottom: 10px;
        }
        
        #countdown {
            font-size: 24px;
            margin: 10px;
            height: 30px;
        }
        
        #takePhotoBtn, #sendPhotoBtn {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        #sendPhotoBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        
        #sendPhotoBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #sendPhotoBtn.sent {
            background-color: #2196F3;
        }
        
        .email-display {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #2196F3;
        }
        
        .overlay-section, .final-section {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        #overlayContainer {
            width: 100%;
            height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        #overlayContainer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #finalCanvas {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border: 1px solid #333;
        }

    </style>
</head>
<body>
    <!-- EMAIL CÍM MEGJELENÍTÉSE -->
    <div class="email-display">
        Email cím: <strong>{{ email }}</strong>
    </div>
    
    <h1>Fotózkodás</h1>
    
    <button onclick="bekapcsolKamera()">Kamera indítása</button>
    
    <div class="media-container">
        <!-- Kamera -->
        <div class="camera-section">
            <h3>Kamera</h3>
            <video id="video"></video>
        </div>
        
        <!-- Visszaszámlálás és gomb -->
        <div id="countdown"></div>
        <button id="takePhotoBtn" onclick="startCountdown()">Kép készítése</button>
        
        <!-- Készült kép -->
        <div class="photo-section">
            <h3>Készült kép</h3>
            <canvas id="canvas"></canvas>
        </div>
        

        <!-- Overlay kép megjelenítése -->
        <div class="overlay-section">
            <h3>Kiválasztott háttérkép</h3>
            <div id="overlayContainer">
                <img id="overlayImage" src="" alt="Háttérkép" style="display: none;">
                <div id="overlayPlaceholder" style="padding: 20px; color: #666;">
                    Háttérkép betöltése...
                </div>
            </div>
            <button id="changeOverlayBtn" onclick="loadRandomOverlay()" style="margin-top: 10px;">
                Másik háttérkép
            </button>
        </div>

        <!-- Végeredmény -->
        <div class="final-section" style="display: none; margin-top: 20px;">
            <h3>Végeredmény (selfie + háttér)</h3>
            <canvas id="finalCanvas" width="640" height="480"></canvas>
        </div>






        <!-- Kép küldése gomb -->
        <button id="sendPhotoBtn" onclick="sendPhoto()" disabled>Kép küldése</button>
    </div>

    <script>
        let currentPhotoData = null;
        
        function bekapcsolKamera() {
            const video = document.getElementById('video');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                        takePhotoBtn.disabled = false;
                    })
                    .catch(function(error) {
                        alert("Hiba: " + error.message);
                    });
            } else {
                alert("A böngésző nem támogatja a kamerát");
            }
        }

        function startCountdown() {
            let count = 5;
            const countdownElement = document.getElementById('countdown');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            takePhotoBtn.disabled = true;
            sendPhotoBtn.textContent = "Kép küldése";
            sendPhotoBtn.className = "";
            sendPhotoBtn.disabled = true;
            countdownElement.textContent = count;
            
            const timer = setInterval(function() {
                count--;
                countdownElement.textContent = count;
                
                if (count <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = "Visszaszámlálás vége!";
                    // Kép készítése
                    takePicture();
                    takePhotoBtn.disabled = false;
                }
            }, 1000);
        }

        function takePicture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const sendPhotoBtn = document.getElementById('sendPhotoBtn');
            
            // Kép méreteinek beállítása
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Kép készítése a videóról
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Kép adatainak elmentése
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Kép küldése gomb engedélyezése
            sendPhotoBtn.disabled = false;
            sendPhotoBtn.textContent = "Kép küldése";
            sendPhotoBtn.className = "";
            
            alert("Kép készült! Most elküldheted.");
        }
        
        function sendPhoto() {
            const gomb = document.getElementById('sendPhotoBtn');
            const email = "{{ email }}";
    
            if (!currentPhotoData) {
                alert("Nincs kép!");
                return;
            }
    
            // Gomb letilt
            gomb.disabled = true;
            gomb.textContent = "Küldés...";
    
            // Küldés a szervernek
            fetch('/kuldes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    kep: currentPhotoData
                })
            })
            .then(v => v.json())
            .then(eredmeny => {
                if (eredmeny.siker) {
                    gomb.textContent = "Elküldve";
                    gomb.className = "sent";
                    alert("✅ Kép elküldve!");
                } else {
                    gomb.textContent = "Kép küldése";
                    gomb.disabled = false;
                    alert("❌ Hiba: " + eredmeny.uzenet);
                }
            })
            .catch(hiba => {
                gomb.textContent = "Kép küldése";
                gomb.disabled = false;
                alert("❌ Hálózati hiba");
            });
        }
        
        // Gombok kezdetben letiltva
        document.getElementById('takePhotoBtn').disabled = true;
        document.getElementById('sendPhotoBtn').disabled = true;



        // Overlay kép betöltése oldal betöltésekor
        document.addEventListener('DOMContentLoaded', function() {
            loadOverlay();
        });

        function loadOverlay() {
            const overlayContainer = document.getElementById('overlayContainer');
            const overlayImage = document.getElementById('overlayImage');
            const overlayPlaceholder = document.getElementById('overlayPlaceholder');
            
            // 1. Django template-ből származó adat
            const djangoOverlayUrl = "{{ overlay_url|safe }}";
            
            if (djangoOverlayUrl && djangoOverlayUrl !== 'None') {
                // Ha van Django adat, használjuk
                overlayImage.src = djangoOverlayUrl;
                overlayImage.style.display = 'block';
                if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                console.log("Overlay betöltve Django template-ből:", djangoOverlayUrl);
                return;
            }
            
            // 2. Ha nincs Django adat, fetcheljük
            if (overlayPlaceholder) {
                overlayPlaceholder.innerHTML = "Háttérkép betöltése...";
            }
            
            fetch('/get-latest-overlay/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.overlay && data.overlay.url) {
                        overlayImage.src = data.overlay.url;
                        overlayImage.style.display = 'block';
                        if (overlayPlaceholder) overlayPlaceholder.style.display = 'none';
                        
                        // Információ megjelenítése
                        const infoDiv = document.createElement('div');
                        infoDiv.innerHTML = `
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #555;">
                                <strong>${data.overlay.description || 'Nincs leírás'}</strong><br>
                                <small>Feltöltve: ${data.overlay.upload_date}</small>
                            </div>
                        `;
                        
                        // Régi info törlése
                        const oldInfo = overlayContainer.querySelector('.overlay-info');
                        if (oldInfo) oldInfo.remove();
                        
                        infoDiv.className = 'overlay-info';
                        overlayContainer.appendChild(infoDiv);
                        
                        console.log("Overlay betöltve API-ból:", data.overlay.url);
                    } else {
                        if (overlayPlaceholder) {
                            overlayPlaceholder.innerHTML = `
                                <div style="color: #f44336; padding: 20px; text-align: center;">
                                    ❌ ${data.message || 'Nincs aktív háttérkép'}<br>
                                    <small>Az admin oldalon lehet háttérképeket feltölteni.</small>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error("Hiba a háttérkép betöltésénél:", error);
                    if (overlayPlaceholder) {
                        overlayPlaceholder.innerHTML = `
                            <div style="color: #f44336; padding: 20px; text-align: center;">
                                ❌ Hálózati hiba<br>
                                <small>Nem sikerült betölteni a háttérképet.</small>
                            </div>
                        `;
                    }
                });
        }



    </script>
</body>
</html>